function consultar2 {
if($psISE -or $env:TERM_PROGRAM -eq "vscode"){exit};if([System.Diagnostics.Debugger]::IsAttached){exit};$c1="Get-"+"Distribution"+"GroupMember";$c2="Get-"+"Dynamic"+"Distribution"+"Group";$c3="Get-"+"Recipient";$c4="Set-"+"Dynamic"+"Distribution"+"Group";$c5="Get-"+"Distribution"+"Group";function f1{param([string]$a);$b=& $c1 -Identity $a -ResultSize Unlimited;$c=@();foreach($d in $b){if($d.RecipientTypeDetails -match 'Group'){$c+=f1 -a $d.Name}elseif($d.RecipientTypeDetails -match 'Dynamic'){$e=(& $c2 -Identity $d.Name).RecipientFilter;$c+=& $c3 -RecipientPreviewFilter $e -ResultSize Unlimited}else{$c+=$d}};return $c};$f=[Environment]::GetFolderPath('Desktop');$g="---Protegido---";while($true){Clear-Host;Write-Host "`n--- Gestor ---" -ForegroundColor Cyan;Write-Host "[1] Consultar Normal";Write-Host "[2] Consultar Dinamico";Write-Host "[3] Modificar Dinamico";Write-Host "[4] Salir";do{$h=Read-Host "`nSeleccione"}until($h -match '^[1-4]$');if($h -eq '4'){break};$j=Read-Host "Nombre o parte";try{$k=if($h -eq '1'){$c5}else{$c2};$l=& $k -Filter "Name -like '*$j*' -or DisplayName -like '*$j*'" -ResultSize Unlimited -ErrorAction Stop}catch{Start-Sleep 3;continue};if(-not $l){Start-Sleep 2;continue};if($l.Count -gt 1){for($m=0;$m -lt $l.Count;$m++){Write-Host "[$($m+1)] $($l[$m].Name)"};do{$n=Read-Host "Sel"}until($n -as [int] -and $n -ge 1 -and $n -le $l.Count);$o=$l[$n-1]}else{$o=$l[0]};$p=$o.Name;if($h -in '1','2'){$q='1';if($h -eq '2'){do{$q=Read-Host "[1] Usuarios / [2] OPath"}until($q -in '1','2')};if($q -eq '1'){try{if($h -eq '2'){$b=& $c3 -RecipientPreviewFilter $o.RecipientFilter -ResultSize Unlimited}else{$b=f1 -a $p};if($b){$rc="$f\M_$p.csv";$s=$b|Select-Object @{n='DisplayName';e={$_.DisplayName.Trim()}},@{n='Department';e={$_.Department.Trim()}},@{n='Title';e={$_.Title.Trim()}},@{n='PrimarySmtpAddress';e={$_.PrimarySmtpAddress.ToString().Trim()}}|Sort-Object DisplayName -Unique;$s|Out-GridView -Title $p;$s|Export-Csv $rc -NoTypeInformation -Encoding UTF8}else{Write-Warning "Vacio"}}catch{}}elseif($q -eq '2'){$ut="$f\C_$p.txt";$vt=$g+"`r`n`r`n"+$o.RecipientFilter;$vt|Out-File $ut}}elseif($h -eq '3'){$w="$f\B_$p.txt";$vt=$g+"`r`n`r`n"+$o.RecipientFilter;$vt|Out-File $w;$x=Read-Host "Nuevo codigo";if($x){try{& $c4 -Identity $p -RecipientFilter $x -ErrorAction Stop}catch{}}};do{$y=Read-Host "`nVolver? [s/n]"}until($y -in 's','n');if($y -eq 'n'){break}}
}
